{% extends "layout.html" %}

{% block content %}
<h2>Enter Evaluation: Step 1</h2>
<p>Select the context to find relevant sections.</p>

<form method="POST" class="row g-3">
    <div class="col-md-6">
        <label class="form-label">Degree Program</label>
        <select name="degree_selection" class="form-select" required>
            <option value="" disabled {% if not context.degree_str %}selected{% endif %}>Select Degree...</option>
            {% for d in degrees %}
                <option value="{{ d.degree_name }}|{{ d.degree_level }}" 
                    {% if context.degree_str == d.degree_name + '|' + d.degree_level %}selected{% endif %}>
                    {{ d.degree_name }} ({{ d.degree_level }})
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">Instructor</label>
        <select name="instructor_id" class="form-select" required>
            <option value="" disabled {% if not context.instructor_id %}selected{% endif %}>Select Instructor...</option>
            {% for i in instructors %}
                <option value="{{ i.instructor_id }}" {% if context.instructor_id == i.instructor_id %}selected{% endif %}>
                    {{ i.last_name }}, {{ i.first_name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">Semester</label>
        <select name="semester" class="form-select" required>
            <option value="Fall" {% if context.semester == 'Fall' %}selected{% endif %}>Fall</option>
            <option value="Spring" {% if context.semester == 'Spring' %}selected{% endif %}>Spring</option>
            <option value="Summer" {% if context.semester == 'Summer' %}selected{% endif %}>Summer</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Year</label>
        <input type="number" name="year" class="form-control" value="{{ context.year or 2024 }}" required>
    </div>

    <div class="col-12">
        <button type="submit" class="btn btn-primary">Find Sections</button>
    </div>
</form>

{% if context %}
<hr>
<h3>Sections Found</h3>
{% if sections %}
    <div class="list-group">
        {% for s in sections %}
            <a href="{{ url_for('enter_evaluation_form',
                                degree_str=context.degree_str,
                                course_code=s.course_code,
                                section_num=s.section_num,
                                semester=context.semester,
                                year=context.year) }}"
               class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ s.course_code }} - Section {{ s.section_num }}</strong><br>
                    {{ s.course_name }}<br>
                    <small class="text-muted">
                        {% if s.expected_evals > 0 %}
                            {{ s.eval_count }} of {{ s.expected_evals }} objectives for this degree
                        {% else %}
                            No objectives defined for this degree/course
                        {% endif %}
                    </small>
                </div>

                <div>
                    {% if s.expected_evals == 0 %}
                        <span class="badge bg-secondary">No Objectives (N/A)</span>
                    {% elif s.eval_count == 0 %}
                        <span class="badge bg-danger">Not Started</span>
                    {% elif s.eval_count < s.expected_evals %}
                        <span class="badge bg-warning text-dark">Partially Entered</span>
                    {% else %}
                        <span class="badge bg-success">Complete (Click to Review/Edit)</span>
                    {% endif %}
                </div>
            </a>
        {% endfor %}
    </div>
{% else %}
    <div class="alert alert-warning">No sections found for this instructor in this semester.</div>
{% endif %}
{% endif %}
{% endblock %}
